#!/usr/bin/env bash

block() {
    local SITE=$1

    if grep -q "$SITE /etc/hosts"; then
        echo "$SITE is already blocked!"
        return 1
    else
        echo -e "127.0.0.1\t$SITE" | tee -a /etc/hosts > /dev/null
    fi
}

unblock() {
    local SITE=$1

    if grep -q "$SITE" /etc/hosts; then
        sed -i'.bak' $'/127.0.0.1\t'"$SITE"'/d' /etc/hosts
    else
        echo "$SITE is not blocked!"
        return 1
    fi
}

list() {
    grep 127.0.0.1 /etc/hosts | grep -v localhost | sed $'s/127.0.0.1\t//g'
}

to_seconds() {
    local TIME_AMOUNT=$1
    local TIME_UNIT=$2

    local TIME_MULTIPLIER=0
    case $TIME_UNIT in
        second|seconds)
            TIME_MULTIPLIER=1
            ;;
        minute|minutes)
            TIME_MULTIPLIER=60
            ;;
        hour|hours)
            TIME_MULTIPLIER=3600
            ;;
        day|days)
            TIME_MULTIPLIER=86400
            ;;
    esac

    local SECONDS=$((TIME_AMOUNT*TIME_MULTIPLIER))
    echo $SECONDS
}

ACTION=$1
shift

case $ACTION in
    list)
        list
        ;;
    block|unblock)
        SITES=()
        MODE='simple'

        while test ${#} -gt 0; do # Loops through all arguments with shift.
            case $1 in
                for)
                    shift
                    TIME_AMOUNT=$1
                    shift
                    TIME_UNIT=$1
                    MODE='for'
                    ;;
                until)
                    shift
                    UNTIL=$1
                    MODE='until'
                    ;;
                *)
                    SITES+=($1)
                    ;;
            esac
            shift
        done

        BLOCKED_SITES=''

        for SITE in "${SITES[@]}"; do
            eval "${ACTION}" "$SITE" # block or unblock.
            if [[ $? == 0 ]]; then
                case $ACTION in
                    'block')
                        ACTION_MSG='Blocked'
                        ;;
                    'unblock')
                        ACTION_MSG='Unblocked'
                        ;;
                esac

                case $MODE in
                    'simple')
                        echo "$ACTION_MSG $SITE"
                        ;;
                    'for')
                        echo "$ACTION_MSG $SITE for $TIME_AMOUNT $TIME_UNIT"
                        ;;
                    'until')
                        echo "$ACTION_MSG $SITE until $UNTIL"
                        ;;
                esac

                BLOCKED_SITES="$BLOCKED_SITES $SITE"
            fi
        done

        case $ACTION in
            'block')
                REVERSE_FN='unblock'
                ;;
            'unblock')
                REVERSE_FN='block'
                ;;
        esac

        case $MODE in
            'for')
                SECONDS=$(to_seconds "$TIME_AMOUNT" "$TIME_UNIT")
                (sleep "$SECONDS"; blk $REVERSE_FN "$BLOCKED_SITES" >& /dev/null)&
                ;;
            'until')
                echo "blk $REVERSE_FN $BLOCKED_SITES" | at "$UNTIL"
                ;;
        esac
        ;;
esac
