#!/usr/bin/env bash

block() {
    if grep -q $1 /etc/hosts; then
        echo "$1 is already blocked!"
    else
        echo -e "127.0.0.1\t$1" | tee -a /etc/hosts > /dev/null
        if [[ $? == 0 ]]; then
            if [[ $2 ]]; then
                (sleep $2; unblock $1 >& /dev/null)&
                echo "Blocked $1 for $2 seconds"
            else
                echo "Blocked $1"
            fi
        fi
    fi
}

unblock() {
    if grep -q $1 /etc/hosts; then
        sed -i'.bak' $'/127.0.0.1\t'"$1"'/d' /etc/hosts

        if [[ $? == 0 ]]; then
            if [[ $2 ]]; then
                (sleep $(($2 * 60)); block $1 >& /dev/null)&
                echo "Unblocked $1 for $2 seconds"
            else
                echo "Unblocked $1"
            fi
        fi
    else
        echo "$1 is not blocked!"
    fi
}

list() {
    cat /etc/hosts | grep 127.0.0.1 | grep -v localhost | sed 's/127.0.0.1\t//g'
}

ACTION=$1
shift

case $ACTION in
    list)
        list
        ;;
    block|unblock)
        TIME=""
        SITES=()
        while test ${#} -gt 0 # Loops through all arguments with shift.
        do
            case $1 in
                for)
                    shift
                    TIME_AMOUNT=$1
                    shift
                    TIME_UNIT=$1
                    TIME_MULTIPLIER=0
                    case $TIME_UNIT in
                        second|seconds)
                            TIME_MULTIPLIER=1
                            ;;
                        minute|minutes)
                            TIME_MULTIPLIER=60
                            ;;
                        hour|hours)
                            TIME_MULTIPLIER=3600
                            ;;
                        day|days)
                            TIME_MULTIPLIER=86400
                            ;;
                    esac
                    TIME=$(($TIME_AMOUNT*$TIME_MULTIPLIER))
                    ;;
                *)
                    SITES+=($1)
                    ;;
            esac
            shift
        done

        for SITE in ${SITES[@]}; do
            eval ${ACTION} $SITE $TIME
        done
        ;;
esac
