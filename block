#!/usr/bin/env bash

to_seconds() {
    local TIME_AMOUNT=$1
    local TIME_UNIT=$2

    local TIME_MULTIPLIER=0
    case $TIME_UNIT in
        second|seconds)
            TIME_MULTIPLIER=1
            ;;
        minute|minutes)
            TIME_MULTIPLIER=60
            ;;
        hour|hours)
            TIME_MULTIPLIER=3600
            ;;
        day|days)
            TIME_MULTIPLIER=86400
            ;;
    esac

    local SECONDS=$(($TIME_AMOUNT*$TIME_MULTIPLIER))
    echo $SECONDS
}

block() {
    local SITE=$1

    if grep -q $SITE /etc/hosts; then
        echo "$SITE is already blocked!"
        return 1
    else
        echo -e "127.0.0.1\t$SITE" | tee -a /etc/hosts > /dev/null
    fi
}

unblock() {
    local SITE=$1

    if grep -q $SITE /etc/hosts; then
        sed -i'.bak' $'/127.0.0.1\t'"$SITE"'/d' /etc/hosts
    else
        echo "$SITE is not blocked!"
        return 1
    fi
}

after_block_simple() {
    local SITE=$1
    echo "Blocked $SITE"
}

after_unblock_simple() {
    local SITE=$1
    echo "Unblocked $SITE"
}

after_block_for() {
    local SITE=$1
    local TIME_AMOUNT=$2
    local TIME_UNIT=$3

    local SECONDS=$(to_seconds $TIME_AMOUNT $TIME_UNIT)

    (sleep $SECONDS; unblock $SITE >& /dev/null)&
    echo "Blocked $SITE for $TIME_AMOUNT $TIME_UNIT"
}

after_unblock_for() {
    local SITE=$1
    local TIME_AMOUNT=$2
    local TIME_UNIT=$3

    local SECONDS=$(to_seconds $TIME_AMOUNT $TIME_UNIT)

    (sleep $SECONDS; block $SITE >& /dev/null)&
    echo "Unblocked $SITE for $TIME_AMOUNT $TIME_UNIT"
}

after_block_until() {
    local SITE=$1
    local UNTIL=$2

    echo "./block unblock $SITE" | at $UNTIL
    echo "Blocked $SITE until $UNTIL"
}

after_unblock_until() {
    local SITE=$1
    local UNTIL=$2

    echo "./block block $SITE" | at $UNTIL
    echo "Unblocked $SITE until $UNTIL"
}

list() {
    cat /etc/hosts | grep 127.0.0.1 | grep -v localhost | sed $'s/127.0.0.1\t//g'
}

ACTION=$1
shift

case $ACTION in
    list)
        list
        ;;
    block|unblock)
        SITES=()
        MODE='simple'

        while test ${#} -gt 0; do # Loops through all arguments with shift.
            case $1 in
                for)
                    shift
                    TIME_AMOUNT=$1
                    shift
                    TIME_UNIT=$1
                    MODE='for'
                    ;;
                until)
                    shift
                    UNTIL=$1
                    MODE='until'
                    ;;
                *)
                    SITES+=($1)
                    ;;
            esac
            shift
        done

        case $MODE in
            'simple')
                ARGS=''
                ;;
            'for')
                ARGS="$TIME_AMOUNT $TIME_UNIT"
                ;;
            'until')
                ARGS=$UNTIL
                ;;
        esac

        AFTER_FN='after_'${ACTION}'_'${MODE} # after_block_simple, after_unblock_for, after_block_until etc.

        for SITE in ${SITES[@]}; do
            eval ${ACTION} $SITE # block or unblock
            if [[ $? == 0 ]]; then
                eval ${AFTER_FN} $SITE $ARGS
            fi
        done
        ;;
esac
