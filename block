#!/usr/bin/env bash

block() {
    if grep -q $1 /etc/hosts; then
        echo "$1 is already blocked!"
    else
        echo -e "127.0.0.1\t$1" | tee -a /etc/hosts > /dev/null
        if [[ $? == 0 ]]; then
            if [[ $2 ]]; then
                (sleep $(($2 * 60)); unblock $1 >& /dev/null)&
                echo "Blocked $1 for $2 minutes"
            else
                echo "Blocked $1"
            fi
        fi
    fi
}

unblock() {
    if grep -q $1 /etc/hosts; then
        sed -i'.bak' $"/127.0.0.1\t$1/d" /etc/hosts

        if [[ $? == 0 ]]; then
            if [[ $2 ]]; then
                (sleep $(($2 * 60)); block $1 >& /dev/null)&
                echo "Unblocked $1 for $2 minutes"
            else
                echo "Unblocked $1"
            fi
        fi
    else
        echo "$1 is not blocked!"
    fi
}

list() {
    cat /etc/hosts | grep 127.0.0.1 | grep -v localhost | sed 's/127.0.0.1\t//g'
}

ACTION=$1
shift

case $ACTION in
    list)
        list
        exit
        ;;
    block|unblock)
        TIME=""
        SITES=()
        while test ${#} -gt 0
        do
            case $1 in
                "-t")
                    shift
                    TIME=$1
                    ;;
                *)
                    SITES+=($1)
                    ;;
            esac
            shift
        done

        for site in ${SITES[@]}; do
            eval ${ACTION} $site $TIME
        done

        echo $TIME
        ;;
esac

# while getopts s:ut:l opt; do
#     case $opt in
#         s)
#             SITE=$OPTARG
#             ;;
#         u)
#             ACTION="unblock"
#             ;;
#         t)
#             TIME=$OPTARG
#             ;;
#         l)
#             ACTION="list"
#             ;;
#     esac
# done

# if [[ $ACTION = "list" ]]; then
#     list
#     exit
# fi
#
# if [[ $SITE ]]; then
#     case $ACTION in
#         block)
#             block $SITE $TIME
#             ;;
#         unblock)
#             unblock $SITE $TIME
#             ;;
#     esac
# else
#     while read pipe; do
#         case $ACTION in
#             block)
#                 block $pipe $TIME
#                 ;;
#             unblock)
#                 unblock $pipe $TIME
#                 ;;
#         esac
#     done
# fi
